%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\documentclass[10pt]{article}
%\usepackage{libertine}
%\usepackage[libertine]{newtxmath}
%\usepackage{classico}

\usepackage{fontspec} 
\usepackage{xunicode}
\usepackage{xltxtra}
\defaultfontfeatures{Mapping=tex-text}
\setromanfont [Ligatures={Common}, Numbers={OldStyle}]{Hoefler Text}
\setmonofont[Scale=0.9]{Source Code Pro} 
\setsansfont[Scale=1.0]{Optima Regular} 
\renewcommand{\familydefault}{\sfdefault}

\usepackage[natbib=true,
            style=numeric,
            sorting=ydnt,
            backend=biber,
            bibencoding=utf8,
            giveninits=true,
            url=false, doi=false,
            defernumbers,
            maxcitenames=3,
            maxbibnames=100]{biblatex}
\addbibresource{rougier2.bib}

\usepackage{xcolor}
\definecolor{blendedblue}{rgb}{0.2, 0.2, 0.6}
\definecolor{blendedred}{rgb}{0.8, 0.2, 0.2}
\definecolor{lightgray}{rgb}{0.7, 0.7, 0.7}
\usepackage[bookmarks=true,
            breaklinks=true,
            pdfborder={0 0 0},
            citecolor=blendedblue,
            colorlinks=true,       % false: boxed links; true: colored links
            linkcolor=blendedblue,
            urlcolor=blendedblue,
            citecolor=blendedblue,
            linktocpage=false,
            hyperindex=true,
            linkbordercolor=white]{hyperref}

\usepackage[rmargin=4.5cm,lmargin=2cm,bmargin=2.5cm,
            marginparwidth=3cm,twoside=false]{geometry}


\usepackage{titlesec}
\titleformat{\subsection}
            {\color{blendedred}\normalfont\large\bfseries}
            {\color{blendedred}\thesection}{1em}{}

% ------------------------------------------------------------------------------------
% Sidenotes
% ------------------------------------------------------------------------------------
\DeclareDatamodelFields[type=field, datatype=literal, skipout=false]{sidenote}
\DeclareFieldFormat{sidenote}{\marginpar{\footnotesize \textsc{\textcolor{lightgray}{#1}}}}

\DeclareBibliographyCategory{Highlight}
\addtocategory{Highlight}{shivkumar:article:2017, rougier:article:2005}

\usepackage{tikz} % Tikz basic
\usetikzlibrary{tikzmark} % Gives \tikzmark for markers
\usetikzlibrary{calc} % Node position calculations
\definecolor{HighlightForeground}{HTML}{000000}
\definecolor{HighlightBackground}{HTML}{F5F5F5}
\def\bibitemstyle{\color{HighlightForeground}}

% New \highlight command for bibitem highlighting
% Takes parameter {entrykey} to make \tikzmark pairs unique
% \highlight command should appear before the text to highlight so it is set behind
\newcommand{\highlight}[1]{%
\begin{tikzpicture}[remember picture, overlay]
\coordinate (begin) at ($ (pic cs:#1beg) + (-.5ex,2ex) $);
\coordinate (end) at ($ (pic cs:#1end) + (0,-.8ex) $);
\coordinate (penult) at ($ (begin |-  end) + (0,-.5ex) $);
\coordinate (right) at ($ (begin) + (\linewidth+1ex,0) $);
\fill[HighlightBackground] (begin) -- (right |- begin)
                                   -- (right |- end)
                                   -- ( begin |- end)
                                   -- cycle;
\end{tikzpicture}}


\AtEveryBibitem{
  \ifcategory{Highlight}%
    {\highlight{\thefield{entrykey}}\tikzmark{\thefield{entrykey}beg}\bibitemstyle}{}
  \printfield{sidenote}%
}
\renewbibmacro*{finentry}{\finentry\tikzmark{\thefield{entrykey}end}}

%  \ifcategory{Highlight}%
%    {\fcolorbox{lightgray}{lightgray}{#1}}%
%    {\bfseries\color{lightgray}}%
%    {}%
%}

% ------------------------------------------------------------------------------------
% No square brackets
% ------------------------------------------------------------------------------------
\DeclareFieldFormat{labelnumberwidth}{#1}

% ------------------------------------------------------------------------------------
% From TeX stack exchange
% "Is it possible to make a reference clickable without showing its DOI or URL field?"
% ------------------------------------------------------------------------------------
\newcommand{\doiorurl}{%
  \iffieldundef{doi}
    {\iffieldundef{url}
       {}
       {\strfield{url}}}
    {http://dx.doi.org/\strfield{doi}}%
}
\newcommand{\myhref}[1]{%
 \ifboolexpr{%
   test {\ifhyperref}
   and
   not test {\iftoggle{bbx:url}}
   and
   not test {\iftoggle{bbx:doi}}
  }
  {\href{\doiorurl}{#1}}
  {#1}%
}
\DeclareFieldFormat{title}{\myhref{\mkbibemph{#1}}}
\DeclareFieldFormat
  [article,inbook,incollection,inproceedings,patent,thesis,unpublished]
  {title}{\myhref{\mkbibquote{#1\isdot}}}




\begin{document}

\nocite{*}

\defbibfilter{book}{keyword={book}}
\defbibfilter{preprint}{keyword={preprint}}
\defbibfilter{journal}{keyword={journal}}
\defbibfilter{chapter}{type=incollection}
\defbibfilter{conference}{type=inproceedings}
\defbibfilter{tutorial}{keyword={tutorial}}
\defbibfilter{popular}{keyword={popular}}
\defbibfilter{invited}{keyword={invited}}

\begin{refcontext}[labelprefix=PP.]
  \printbibliography[heading=subbibliography,
                     title={Preprints},
                     filter=preprint]
\end{refcontext}

\begin{refcontext}[labelprefix=IJ.]
  \printbibliography[heading=subbibliography,
                     title={Journals},
                     filter=journal]
\end{refcontext}

\begin{refcontext}[labelprefix=BK.]
  \printbibliography[heading=subbibliography,
                     title={Book \& Thesis},
                     filter=book]
\end{refcontext}

\begin{refcontext}[labelprefix=CH.]
  \printbibliography[heading=subbibliography,
                     title={Book Chapters},
                     filter=chapter]
\end{refcontext}

\begin{refcontext}[labelprefix=CI.]
  \printbibliography[heading=subbibliography,
                     title={Conferences/Short Papers/Posters},
                     filter=conference]
\end{refcontext}

\begin{refcontext}[labelprefix=SO.]
  \printbibliography[heading=subbibliography,
                     title={Science Outreach},
                     filter=popular]
\end{refcontext}

\begin{refcontext}[labelprefix=TU.]
  \printbibliography[heading=subbibliography,
                     title={Tutorials},
                     filter=tutorial]
\end{refcontext}

\begin{refcontext}[labelprefix=IV.]
  \printbibliography[heading=subbibliography,
                     title={Invited Talks \& Lectures},
                     filter=invited]
\end{refcontext}

\end{document}
